---
title: "Participation and waterbody type with heterogeneity"
output: html_document
date: "2024-02-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, here, lubridate, apollo, fastDummies, RColorBrewer)
```


Data prep copied from nested.logit (actually MNL) script
```{r}
choiceData<-read_csv(here::here("data","choice.data.participation.waterbody.type.csv"))
choiceData<-choiceData[,-1]

greatLake<-choiceData%>%
  filter(WaterFished%in%c("Lake Michigan","Lake Superior"))%>%
  group_by(WaterFished)%>%
  summarize(n=n())
# hm, not that many.

holidays<-mdy(c("05/31/2021","09/06/2021","11/25/2021","12/31/2021",
                "01/17/2022"))

coastal<-read_csv(here::here("data","coastalCounties.csv"))

river<-coastal%>%
  filter(grepl("River", waterbody))

greatLake<-coastal%>%
  filter(grepl("Lake", waterbody))

lakeMichigan<-coastal%>%
  filter(waterbody=="Lake Michigan")

lakeSuperior<-coastal%>%
  filter(waterbody=="Lake Superior")

choiceData.cov<-choiceData%>%
  mutate(Date=mdy(Date),
         month=as.character(month(Date, label=T)),
         weekday=wday(Date, label=T),
         weekendHoliday=ifelse(weekday%in%c("Sun","Sat") | Date%in%holidays, 1, 0),
         coastal_greatLake=ifelse(PrimaryCounty%in%greatLake$county, 1, 0),
         coastal_river=ifelse(PrimaryCounty%in%river$county, 1, 0),
         coastal_lakeMichigan=ifelse(PrimaryCounty%in%lakeMichigan$county, 1, 0),
         coastal_lakeSuperior=ifelse(PrimaryCounty%in%lakeSuperior$county, 1, 0),
         age=2022-YearOfBirth)%>%
  select(SurveyID, age, Gender, PrimaryCounty, Date, fishedEver, FishedYN, WaterFished, County, Hours:waterbodyType,
         coastal_greatLake, coastal_river, coastal_lakeMichigan, coastal_lakeSuperior, month, weekday, weekendHoliday)%>%
  mutate(age.sc=scale(age, center=T, scale=T),
         choice.partic=ifelse(FishedYN==0, "noFish", "fish"),
         choice.waterbody=ifelse(FishedYN==0, "noFish",
                       ifelse(waterbodyType=="river", "river",
                              ifelse(waterbodyType=="greatLake", "greatLake",
                                     ifelse(waterbodyType=="inlandLake", "inlandLake","error")))),
         choice=ifelse(fishedEver==0, "neverFished",
                       ifelse(FishedYN==0, "notToday",
                              ifelse(waterbodyType=="river","river",
                                     ifelse(waterbodyType=="greatLake", "greatLake",
                                            ifelse(waterbodyType=="inlandLake", "inlandLake", "error"))))),
         choice.specificLake=ifelse(FishedYN==0, "noFish", 
                                    ifelse(waterbodyType=="river","river",
                                           ifelse(waterbodyType=="inlandLake", "inlandLake",
                                                  ifelse(WaterFished=="Lake Michigan", "lakeMichigan",
                                                         ifelse(WaterFished=="Lake Superior", "lakeSuperior", "error"))))),
         age_weekend=age.sc*weekendHoliday,
         female=ifelse(Gender=="FEMALE", 1, 0))%>%
  mutate(shoulder=ifelse(month%in%c("Oct","Nov","Mar","Apr"), 1, 0),
         peakSummer=ifelse(month%in%c("May","Jun","Jul"), 1, 0))


choiceData.dum<-dummy_cols(choiceData.cov, select_columns="month",
                           remove_first_dummy=F,
                           remove_selected_columns=T)%>%
  filter(!is.na(female))

```


pasted MNL model to add on random variation in coefficients. What I'm hoping to see is some variation in the fish alternative specific constant, the importance of large waterbody proximity, and ASCs for particular waterbody types. This may help distinguish the preferences of frequent anglers from casual anglers. (It may also be worth trying a latent class model for this)
```{r}
# ################################################################# #
#### LOAD LIBRARY AND DEFINE CORE SETTINGS                       ####
# ################################################################# #


### Initialise code
apollo_initialise()

### Set core controls
apollo_control = list(
  modelName       = "MMNL_participate_waterbodyType",
  modelDescr      = "MMNL participation and waterbody type",
  indivID         = "SurveyID", 
  nCores          = 3,
  outputDirectory = "output_mixed_mnl_fish_waterbody"
)

# ################################################################# #
#### LOAD DATA AND APPLY ANY TRANSFORMATIONS                     ####
# ################################################################# #

### Loading data from package
### if data is to be loaded from a file (e.g. called data.csv), 
### the code would be: database = read.csv("data.csv",header=TRUE)
database = choiceData.dum
### for data dictionary, use ?apollo_modeChoiceData


# ################################################################# #
#### DEFINE MODEL PARAMETERS                                     ####
# ################################################################# #

### Vector of parameters, including any that are kept fixed in estimation. no observations in november, left out on purpose. 
apollo_beta=c( mu_asc_noFish=0,
               mu_asc_fish=0,
               mu_asc_lakeMichigan=0,
               mu_asc_lakeSuperior=0,
               mu_asc_river=0,
               mu_b_coastal_lakeMichigan=0,
               mu_b_coastal_lakeSuperior=0,
               mu_b_coastal_river=0,
               b_weekend_holiday=0,
               b_age=0,
               b_female=0,
               b_weekend_age=0,
                b_month_Feb=0,
                b_month_Mar=0,
                b_month_Apr=0,
                b_month_May=0,
                b_month_Jun=0,
                b_month_Jul=0,
                b_month_Aug=0,
                b_month_Sep=0,
                b_month_Oct=0,
                # no November data
                b_month_Dec=0
              )

### Vector with names (in quotes) of parameters to be kept fixed at their starting value in apollo_beta, use apollo_beta_fixed = c() if none
apollo_fixed = c("asc_noFish")

# ################################################################# #
#### GROUP AND VALIDATE INPUTS                                   ####
# ################################################################# #

apollo_inputs = apollo_validateInputs()

# ################################################################# #
#### DEFINE MODEL AND LIKELIHOOD FUNCTION                        ####
# ################################################################# #

apollo_probabilities=function(apollo_beta, apollo_inputs, functionality="estimate"){

  ### Attach inputs and detach after function exit
  apollo_attach(apollo_beta, apollo_inputs)
  on.exit(apollo_detach(apollo_beta, apollo_inputs))

  ### Create list of probabilities P
  P = list()
  
  ### create alternative specific constants
  
  asc_fish_value = asc_fish + b_weekend_holiday * weekendHoliday + b_month_Feb * month_Feb + 
    b_month_Mar * month_Mar + b_month_Apr * month_Apr + b_month_May * month_May +
    b_month_Jun * month_Jun + b_month_Jul * month_Jul + b_month_Aug * month_Aug +
    b_month_Sep * month_Sep + b_month_Oct * month_Oct + b_month_Dec * month_Dec +
    b_age * age.sc + b_weekend_age * age_weekend + b_female * female
  
  asc_lakeMichigan_value = asc_lakeMichigan +b_coastal_lakeMichigan * coastal_lakeMichigan
  asc_lakeSuperior_value = asc_lakeSuperior + b_coastal_lakeSuperior * coastal_lakeSuperior
  
  ### List of utilities: these must use the same names as in mnl_settings, order is irrelevant

  V = list()
  V[["noFish"]] = asc_noFish 
  V[["river"]] = asc_fish_value + asc_river + b_coastal_river * coastal_river
  V[["lakeMichigan"]] =  asc_fish_value + asc_lakeMichigan_value 
  V[["lakeSuperior"]] = asc_fish_value + asc_lakeSuperior_value 
  V[["inlandLake"]] = asc_fish_value 

 ### Define settings for MNL model component
  mnl_settings = list(
    alternatives = c(noFish="noFish", river="river", lakeMichigan="lakeMichigan", lakeSuperior="lakeSuperior", inlandLake="inlandLake"),
    choiceVar    = choice.specificLake,
    utilities    = V
  )
  
  ### Compute probabilities using MNL model
  P[["model"]] = apollo_mnl(mnl_settings, functionality)
  
  ### Take product across observation for same individual
  P = apollo_panelProd(P, apollo_inputs, functionality)
  
  ### Prepare and return outputs of function
  P = apollo_prepareProb(P, apollo_inputs, functionality)
  return(P)
}

# ################################################################# #
#### MODEL ESTIMATION                                            ####
# ################################################################# #

model = apollo_estimate(apollo_beta, apollo_fixed, apollo_probabilities, apollo_inputs)

# ################################################################# #
#### MODEL OUTPUTS                                               ####
# ################################################################# #

# ----------------------------------------------------------------- #
#---- FORMATTED OUTPUT (TO SCREEN)                               ----
# ----------------------------------------------------------------- #

apollo_modelOutput(model)

# ----------------------------------------------------------------- #
#---- FORMATTED OUTPUT (TO FILE, using model name)               ----
# ----------------------------------------------------------------- #

apollo_saveOutput(model)

# ################################################################# #
##### POST-PROCESSING                                            ####
# ################################################################# #

### Print outputs of additional diagnostics to new output file (remember to close file writing when complete)
apollo_sink()
```
